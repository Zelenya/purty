image: node:10.16.0@sha256:7cae3b2b42bde73b68e82fbd949cfff5b43546c2daabba3e95c8a603a04eec09

cache:
  key: purty-v1
  paths:
    - .stack-root
    - .stack-work

variables:
  STACK_ROOT: $CI_PROJECT_DIR/.stack-root
  
stages:
  - build

Build purty:
  before_script:
    - echo '55db464778cba4fe5aa10bdfd7ae7f283b5e646539a7086776785a7fae41a8b9  get-stack.sh' > SHA256SUM
    - curl --location --output get-stack.sh --show-error --silent https://raw.githubusercontent.com/commercialhaskell/stack/d36d8136a8b4d3384fd0082191737eaa517fddfb/etc/scripts/get-stack.sh
    - shasum --check SHA256SUM
    - chmod 0755 get-stack.sh
    - ./get-stack.sh
    - export PATH=$HOME/.local/bin:$PATH
    - stack setup
  script:
    - ci/lint/stylish-haskell.sh --verbose
    - ci/lint/hlint.sh --verbose
    - stack build --copy-bins --coverage --local-bin-path bin --no-run-tests --test
    - stack build --copy-bins --coverage --local-bin-path bin/linux --no-run-tests --test
    - stack build --coverage --test
    - echo Testing binary interface
    - test/acceptance.sh --verbose
    - echo Testing npm interface
    - test/acceptance.sh --purty $(pwd)/bin/purty.js --verbose
  stage: build
